<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clear Service Worker</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
      text-align: center;
    }
    h1 {
      margin: 0 0 20px;
      color: #333;
    }
    p {
      color: #666;
      line-height: 1.6;
      margin: 0 0 30px;
    }
    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #4338CA;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }
    button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
    }
    .status.success {
      background: #D1FAE5;
      color: #065F46;
    }
    .status.error {
      background: #FEE2E2;
      color: #991B1B;
    }
    .status.info {
      background: #DBEAFE;
      color: #1E40AF;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ Clear Service Worker</h1>
    <p>This will unregister all service workers and clear all caches. This should fix the "Failed to update ServiceWorker" error.</p>
    <button id="clearBtn" onclick="clearServiceWorker()">Clear Service Worker & Caches</button>
    <div id="status"></div>
  </div>

  <script>
    async function clearServiceWorker() {
      const btn = document.getElementById('clearBtn');
      const status = document.getElementById('status');
      
      btn.disabled = true;
      btn.textContent = 'Clearing...';
      status.className = 'status info';
      status.textContent = 'Working...';

      try {
        let cleared = 0;

        // Unregister all service workers
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (const registration of registrations) {
            await registration.unregister();
            cleared++;
          }
          status.textContent = `Unregistered ${cleared} service worker(s)...`;
        }

        // Clear all caches
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          for (const name of cacheNames) {
            await caches.delete(name);
          }
          status.textContent = `Cleared ${cacheNames.length} cache(s)...`;
        }

        // Clear localStorage items related to service worker
        const swKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.startsWith('sw-') || key.includes('service-worker'))) {
            swKeys.push(key);
          }
        }
        swKeys.forEach(key => localStorage.removeItem(key));

        // Success
        status.className = 'status success';
        status.innerHTML = `
          âœ… Successfully cleared!<br>
          <small>Unregistered ${cleared} service worker(s) and cleared ${cacheNames ? cacheNames.length : 0} cache(s)</small>
        `;

        // Reload after 2 seconds
        setTimeout(() => {
          status.innerHTML = 'ðŸ”„ Reloading page...';
          setTimeout(() => {
            window.location.href = '/';
          }, 500);
        }, 2000);

      } catch (error) {
        console.error('Error clearing service worker:', error);
        status.className = 'status error';
        status.textContent = `âŒ Error: ${error.message}`;
        btn.disabled = false;
        btn.textContent = 'Try Again';
      }
    }

    // Auto-check status on load
    window.addEventListener('load', async () => {
      const status = document.getElementById('status');
      status.className = 'status info';
      
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        const cacheNames = await caches.keys();
        
        if (registrations.length > 0 || cacheNames.length > 0) {
          status.textContent = `Found ${registrations.length} service worker(s) and ${cacheNames.length} cache(s)`;
        } else {
          status.textContent = 'No service workers or caches found';
        }
      }
    });
  </script>
</body>
</html>
