generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(SUBJECT_TEACHER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Student {
  id             String       @id @default(cuid())
  studentId      String?      @unique
  firstName      String
  lastName       String
  khmerName      String?
  englishName    String?
  email          String?      @unique
  dateOfBirth    DateTime
  gender         Gender
  placeOfBirth   String?
  currentAddress String?
  address        String?
  phone          String?
  phoneNumber    String?
  classId        String?
  
  // ✅ NEW: Exam-related fields
  previousGrade  String?      // ឡើងពីថ្នាក់ទី
  passedStatus   String?      // ត្រួត (ជាប់/ធ្លាក់)
  examSession    String?      // សម័យប្រឡង
  examCenter     String?      // ម.ប្រឡង
  examRoom       String?      // បន្ទប់
  examDesk       String?      // លេខតុ
  remarks        String?      // ផ្សេងៗ
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  attendance     Attendance[]
  grades         Grade[]
  class          Class?       @relation(fields: [classId], references: [id])

  @@map("students")
}

model Teacher {
  id                 String           @id @default(cuid())
  teacherId          String?          @unique
  firstName          String
  lastName           String
  khmerName          String?
  englishName        String?
  email              String           @unique
  phone              String?
  phoneNumber        String?
  subject            String?
  employeeId         String?          @unique
  gender             Gender?
  dateOfBirth        DateTime?
  position           String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  
  classes            Class[]
  subjectAssignments SubjectTeacher[]

  @@map("teachers")
}

model Class {
  id           String       @id @default(cuid())
  classId      String?      @unique
  name         String
  grade        String
  section      String?
  academicYear String       @default("2024-2025")
  capacity     Int?
  teacherId    String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  
  teacher      Teacher?     @relation(fields: [teacherId], references: [id])
  students     Student[]
  attendance   Attendance[]

  @@map("classes")
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  nameKh      String
  nameEn      String?
  code        String   @unique
  description String?
  grade       String
  track       String?
  category    String   // "social" | "science"
  weeklyHours Float    @default(0)
  annualHours Int      @default(0)
  maxScore    Int      @default(100)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacherAssignments SubjectTeacher[]
  grades             Grade[]

  @@map("subjects")
}

model SubjectTeacher {
  id        String   @id @default(cuid())
  subjectId String
  teacherId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([subjectId, teacherId])
  @@map("subject_teachers")
}

model Grade {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  score     Float
  maxScore  Float
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@map("grades")
}

model Attendance {
  id        String           @id @default(cuid())
  studentId String
  classId   String?
  date      DateTime
  status    AttendanceStatus
  remarks   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  class     Class?           @relation(fields: [classId], references: [id])

  @@map("attendance")
}

enum Role {
  ADMIN
  CLASS_TEACHER
  SUBJECT_TEACHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}